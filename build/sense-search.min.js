var SenseSearchInput=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-input-container");var d=f.replace(/{id}/gim,a);c.innerHTML=d,b=b||{};for(var e in b)this[e]=b[e];this.id=a,c.onkeyup=this.onKeyUp.bind(this),c.onkeydown=this.onKeyDown.bind(this),c.onclick=this.onClick.bind(this);var g=document.getElementById(a);if(g){g.insertAdjacentElement?g.insertAdjacentElement("afterEnd",c):g.insertAdjacentHTML("afterEnd",c.outerHTML);for(var h=0;h<g.attributes.length;h++)this[g.attributes[h].name]=g.attributes[h].value;g.parentNode.removeChild(g)}return this.searchFields&&!Array.isArray(this.searchFields)&&this.searchFields.length&&(this.searchFields=this.searchFields.split(",")),this.suggestFields&&!Array.isArray(this.suggestFields)&&this.suggestFields.length&&(this.suggestFields=this.suggestFields.split(",")),this.searchTimeout=this.searchTimeout||300,this.suggestTimeout=this.suggestTimeout||100,senseSearch.ready.subscribe(this.activate.bind(this)),{element:c,object:this}}function b(a,b){var c=a;if(-1!=b.toLowerCase().indexOf(c.toLowerCase()));else if(b.length>c.length)for(;-1==b.toLowerCase().indexOf(c.toLowerCase());)c=c.split(" "),c.splice(0,1),c=c.join(" ");for(;c.length>=b.length&&c.toLowerCase()!=b.toLowerCase();)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}var c=[16,27],d=[9,13,38,40,39,37,32,33,34],e={BACKSPACE:8,ESCAPE:27,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32},f="<div class=''><div id='{id}_ghost' class='sense-search-input-bg'></div><input id='{id}_input' autofocus placeholder='Please wait...' disabled='disabled' type='text' autocorrect='off' autocomplete='off' autocapitalize='off' spellcheck='false' /><div class='sense-search-lozenge-container'></div><button type='button' class='sense-search-input-clear'>x</button></div><div id='{id}_suggestions' class='sense-search-suggestion-container'><ul></ul></div>";return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:null},attach:{value:function(a){if(a)for(var b in a)this[b]=a[b];senseSearch&&senseSearch.exchange.connection&&(senseSearch.suggestResults.subscribe(this.onSuggestResults.bind(this)),senseSearch.inputs[this.id]||(senseSearch.inputs[this.id]=this))}},searchText:{writable:!0,value:null},searchFields:{writable:!0,value:[]},suggestFields:{writable:!0,value:[]},searchTimeout:{writable:!0,value:null},suggestTimeout:{writable:!0,value:null},searchTimeoutFn:{writable:!0,value:null},suggestTimeoutFn:{writable:!0,value:null},suggesting:{writable:!0,value:!1},suggestingTimeout:{writable:!0,value:3e3},suggestingTimeoutFn:{writable:!0,value:null},activeSuggestion:{writable:!0,value:0},ghostPart:{writable:!0,value:null},ghostQuery:{writable:!0,value:null},ghostDisplay:{writable:!0,value:null},cursorPosition:{writable:!0,value:0},onSearchResults:{value:function(){}},onSuggestResults:{value:function(a){this.suggestions=a.qSuggestions,this.suggestions.splice(5,a.qSuggestions.length-4),this.showSuggestions()}},clear:{value:function(){senseSearch.clear()}},onClick:{value:function(){console.log("click")}},onKeyDown:{value:function(a){if(a.keyCode==e.ESCAPE)return void this.hideSuggestions();if(a.keyCode==e.DOWN)this.showSuggestions();else if(a.keyCode==e.RIGHT)this.suggesting&&(a.preventDefault(),this.nextSuggestion());else if(a.keyCode==e.LEFT)this.suggesting&&(a.preventDefault(),this.prevSuggestion());else if(a.keyCode==e.ENTER||a.keyCode==e.TAB)this.suggesting&&(a.preventDefault(),this.acceptSuggestion());else if(a.keyCode==e.SPACE){if(5==this.searchText.split(" ").length)return alert("Too many search terms"),a.preventDefault(),!1;if(1==$scope.searchText.split(" ").pop().length)return alert("cannot search for single character strings"),a.preventDefault(),!1;this.hideSuggestions()}else this.hideSuggestions()}},onKeyUp:{value:function(a){this.searchText=document.getElementById(this.id+"_input").value,this.cursorPosition=a.target.selectionStart,-1==c.indexOf(a.keyCode)&&-1==d.indexOf(a.keyCode)&&(this.searchText&&this.searchText.length>0?this.searchText.split(" ").pop().length>1&&(this.search(),this.suggest()):this.clear())}},showSuggestions:{value:function(){this.suggestingTimeoutFn&&clearTimeout(this.suggestingTimeoutFn),this.suggestingTimeoutFn=setTimeout(function(){this.hideSuggestions.call(this)}.bind(this),this.suggestingTimeout),this.searchText&&this.searchText.length>1&&this.cursorPosition==this.searchText.length&&this.suggestions.length>0?(this.suggesting=!0,this.drawGhost()):(this.suggesting=!1,this.removeGhost())}},hideSuggestions:{value:function(){this.suggesting=!1,this.activeSuggestion=0,this.ghostPart="",this.ghostQuery="",this.ghostDisplay=""}},nextSuggestion:{value:function(){this.activeSuggestion==this.suggestions.length-1?this.activeSuggestion=0:this.activeSuggestion++,this.drawGhost()}},prevSuggestion:{value:function(){0==this.activeSuggestion?this.activeSuggestion=this.suggestions.length-1:this.activeSuggestion--,this.drawGhost()}},acceptSuggestion:{value:function(){this.searchText=this.ghostQuery,this.suggestions=[],this.hideSuggestion(),this.search()}},search:{value:function(){var a=this;this.searchTimeoutFn&&clearTimeout(this.searchTimeoutFn),this.searchTimeoutFn=setTimeout(function(){senseSearch.search(a.searchText,a.searchFields||[])},this.searchTimeout)}},suggest:{value:function(){var a=this;this.searchText.length>1&&this.cursorPosition==this.searchText.length&&(this.suggestTimeoutFn&&clearTimeout(this.suggestTimeoutFn),this.suggestTimeoutFn=setTimeout(function(){senseSearch.suggest(a.searchText,a.suggestFields||[])},this.suggestTimeout))}},drawGhost:{value:function(){this.ghostPart=b(this.searchText,this.suggestions[this.activeSuggestion].qValue),this.ghostQuery=this.searchText+this.ghostPart;var a="<span style='color: transparent;'>"+this.searchText+"</span>"+this.ghostPart;document.getElementById(this.id+"_ghost").innerHTML=a}},removeGhost:{value:function(){document.getElementById(this.id+"_ghost").innerHTML=""}},activate:{value:function(){this.attach();var a=document.getElementById(this.id+"_input");a.attributes.placeholder.value="Enter up to 5 search terms",a.disabled=!1}}}),a}(),SenseSearchResult=function(){function a(a,b){var c=document.createElement("div");c.id=a,c.classList.add("sense-search-results-container"),b=b||{};for(var d in b)this[d]=b[d];this.id=a;var e=document.getElementById(a);if(e){e.insertAdjacentElement?e.insertAdjacentElement("afterEnd",c):e.insertAdjacentHTML("afterEnd",c.outerHTML);for(var f=0;f<e.attributes.length;f++)this[e.attributes[f].name]=e.attributes[f].value;e.parentNode.removeChild(e)}return{element:c,object:this}}function b(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};f[b[a[d].dimension].sortType]=b[a[d].dimension].order,e.qDef.qSortCriterias=[f]}c.push(e)}return c}function c(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};a[c].sortType&&(d.qSortBy={},d.qSortBy[a[c].sortType]=a[c].order),b.push(d)}return b}return a.prototype=Object.create(Object.prototype,{id:{writable:!0,value:!1},handle:{writable:!0,value:!1},attach:{value:function(a){var b=this;if(a)for(var c in a)this[c]=a[c];if(senseSearch&&senseSearch.exchange.connection){var d=this.buildHyperCubeDef();senseSearch.exchange.ask(senseSearch.appHandle,"CreateSessionObject",[d],function(a){b.handle=a.result.qReturn.qHandle}),senseSearch.searchResults.subscribe(this.onSearchResults.bind(this)),senseSearch.results[this.id]=this}}},fields:{writable:!0,value:[]},data:{writable:!0,value:[]},sortOptions:{writable:!0,value:{}},defaultSort:{writable:!0,value:null},enableHighlighting:{writable:!0,value:!0},pageTop:{writable:!0,value:0},pageSize:{writable:!0,value:20},buildHyperCubeDef:{value:function(){var a={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:b(this.fields,this.sortOptions),qMeasures:c(this.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:this.getFieldIndex(this.defaultSort,!1)}};return a}},onSearchResults:{value:function(a){this.getHyperCubeData()}},getHyperCubeData:{value:function(){var a=this;senseSearch.exchange.getLayout(this.handle,function(b){var c=b.result.qLayout,d=c.qHyperCube.qDimensionInfo.concat(c.qHyperCube.qMeasureInfo);senseSearch.exchange.ask(a.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:a.pageTop,qLeft:0,qHeight:a.pageSize,qWidth:a.fields.length}]],function(b){for(var c=b.result.qDataPages,e=[],f=0;f<c[0].qMatrix.length;f++){var g={};if(!this.nullSuppressor||null==this.nullSuppressor||"-"!=c[0].qMatrix[f][$scope.config.nullSuppressor].qText){for(var h=0;h<c[0].qMatrix[f].length;h++)g[d[h].qFallbackTitle]={value:c[0].qMatrix[f][h].qText,html:a.highlightText(c[0].qMatrix[f][h].qText)};e.push(g)}}this.data=e;for(var i="",f=0;f<this.data.length;f++){i+="<div class='sense-search-result'>";for(var j in this.data[f])i+="<div>",i+="<strong>",i+=j,i+=":</strong>",i+=this.data[f][j].html,i+="</div>";i+="</div>"}document.getElementById(a.id).innerHTML=i})})}},getFieldIndex:{value:function(a,b){for(var c=0;c<this.fields.length;c++){if(this.fields[c].dimension&&this.fields[c].dimension==a)return void 0!=b&&0==b?[c]:"["+c+"]";if(this.fields[c].label&&this.fields[c].label==a)return void 0!=b&&0==b?[c]:"["+c+"]"}return 0}},highlightText:{value:function(a){if(senseSearch.terms&&this.enableHighlighting){for(var b=senseSearch.terms,c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a}}}),a}(),SenseSearch=function(){function a(){var a,b,c=0,d=10;this.connect=function(e,f){b=f;try{a=new WebSocket(e)}catch(g){}a.onopen=function(){console.log("Socket connected! readyState = "+a.readyState),c=0,b.call(null,{method:"connected"})},a.onmessage=function(a){var c;c=a.data,b.call(null,JSON.parse(c))},a.onerror=function(a){b.call(null,null)},a.onclose=function(e){d>c?(c++,console.warn("Socket closed! --> Reconnect in 5 secs (retry "+c+")"),setTimeout(function(){3===a.readyState&&b.call(null,{method:"socketClosed",isConnecting:!1})},5e3)):(console.warn("Sorry, can't reconnect socket aftet "+d+" retries"),c=0)}},this.sendMessage=function(c,d){b=d;try{a.send(JSON.stringify(c))}catch(e){throw e}}}function b(){this.callbackList=[]}function c(){this.ready=new b,this.searchResults=new b,this.suggestResults=new b,this.cleared=new b}var d=function(){function b(b,c){if(!b.app)return!1;b=b||{},b.host?b.port=b.port||"":b.port="4848",b.host=b.host||"localhost",b.prefix=b.prefix||"",b.isSecure=b.isSecure||"https:"==window.location.protocol,b.ticket=b.ticket||!1;var d="ws";d+=b.isSecure?"s://":"://",d+=b.host,d+=b.port?":"+b.port:"",d+=b.prefix,d+="/app/",d+=b.app,d+=b.ticket?"qlikTicket="+b.ticket:"",this.connection=new a,this.connection.connect(d,c)}return b.prototype=Object.create(Object.prototype,{connection:{writable:!0,value:null},ask:{value:function(a,b,c,d,e){var f={id:d,handle:a,method:b,params:c};this.connection.sendMessage(f,e)}}}),b}();b.prototype=Object.create(Object.prototype,{subscribe:{value:function(a){this.callbackList.push(a)}},deliver:{value:function(a){for(var b=0;b<this.callbackList.length;b++)this.callbackList[b].call(null,a)}}});var e=function(){function a(a,b,c){var e=this;this.connectionType=b,"Native"==b?this.connection=new d(a,function(){e.connection.ask(-1,"OpenDoc",[a.app],0,function(a){c.call(null,a)})}):"QSocks"==b?(this.connection=a,this.seqId=this.connection.seqid):"CapabilityAPI"==b&&(this.connection=a)}return a.prototype=Object.create(Object.prototype,{connectionType:{writable:!0,value:null},seqId:{writable:!0,value:0},connection:{writable:!0,value:null},ask:{value:function(a,b,c,d){switch(this.connectionType){case"Native":this.askNative(a,b,c,d);break;case"QSocks":this.askQSocks(a,b,c,d);break;case"CapabilityAPI":this.askCapabilityAPI(a,b,c,d)}"Native"==this.connectionType}},askNative:{value:function(a,b,c,d){this.seqId++,this.connection.ask(a,b,c,this.seqId,function(a){a.error||d.call(null,a)})}},askQSocks:{value:function(a,b,c,d){this.seqId++,this.connection.ask(a,b,c,this.seqId).then(function(a){a.error||d.call(null,a)})}},askCapabilityAPI:{value:function(a,b,c,d){var e=this;this.connection.rpc({handle:a,method:b,params:c}).then(function(a){e.seqId=a.id,a.error||d.call(null,a)})}},getLayout:{value:function(a,b){this.ask(a,"GetLayout",[],b)}}}),a}();return c.prototype=Object.create(Object.prototype,{init:{value:function(){for(var a=document.getElementsByTagName("sense-search-input"),b=0;b<a.length;){var c=a[b].id,d=new SenseSearchInput(c);this.inputs[c]=d.object}for(var e=document.getElementsByTagName("sense-search-results"),b=0;b<e.length;){var c=e[b].id,f=new SenseSearchResult(c);this.results[c]=f.object}}},inputs:{writable:!0,value:{}},results:{writable:!0,value:{}},pendingSearch:{writable:!0,value:null},pendingSuggest:{writable:!0,value:null},appHandle:{writable:!0,value:null},exchange:{writable:!0,value:null},connect:{value:function(a,b){var c=this;this.exchange=new e(a,"Native",function(a){a.result&&a.result.qReturn&&(c.appHandle=a.result.qReturn.qHandle,c.ready.subscribe(b),c.ready.deliver())})}},connectWithQSocks:{value:function(a){this.appHandle=a.handle,this.exchange=new e(a.connection,"QSocks"),this.ready.deliver()}},connectWithCapabilityAPI:{value:function(a){this.appHandle=a.global.session.connectedAppHandle,this.exchange=new e(a.global.session,"CapabilityAPI"),this.ready.deliver(),console.log(a)}},readOptions:{value:function(a){for(var b in a)this[0]=a[b]}},ready:{writable:!0,value:null},newResultsDefinition:{value:function(a,b,c){var d=new Result(a);this.results.push(d)}},search:{value:function(a,b,c){var d=this;this.pendingSearch=this.exchange.seqId+1,this.terms=a.split(" "),this.exchange.ask(this.appHandle,"SearchAssociations",[{qContext:c||this.context||"LockedFieldsOnly",qSearchFields:b},this.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],function(e){e.id==d.pendingSearch&&(""==a||e.result.qResults.qTotalSearchResults>0?d.exchange.ask(d.appHandle,"SelectAssociations",[{qContext:c||d.context||"LockedFieldsOnly",qSearchFields:b},d.terms,0],function(a){d.searchResults.deliver(a.change)}):d.clear())})}},suggest:{value:function(a,b,c){var d=this;d.pendingSuggest=this.exchange.seqId+1,this.exchange.ask(this.appHandle,"SearchSuggest",[{qContext:c||this.context||"LockedFieldsOnly",qSearchFields:b},a.split(" ")],function(a){a.id==d.pendingSuggest&&d.suggestResults.deliver(a.result.qResult)})}},clear:{value:function(){this.terms=null,this.cleared.deliver()}},searchResults:{writable:!0,value:null},suggestResults:{writable:!0,value:null}}),c}(),senseSearch=new SenseSearch;senseSearch.init();